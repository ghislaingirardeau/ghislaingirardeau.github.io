import{_ as N,r as l,o as S,B as g,S as x,C as y,Q as h,X as v,E as u,D as f,a8 as T,a6 as O,F as j,N as k,G as D,a7 as V,q as J,aV as P}from"./index-BA5aWebT.js";import{C as q}from"./ClosePopup-JG327cVg.js";import{G as Q,u as R,m as U,V as L}from"./index-BqawO4WD.js";const z={__name:"AuthentificationWidget",setup(A,{expose:s}){s();const o=l(!1),e=l(""),r=l(!1),c=l(!0),d=l(!1),m=l(!1),n=t=>btoa(String.fromCharCode(...new Uint8Array(t))),w=t=>Uint8Array.from(atob(t),i=>i.charCodeAt(0));S(()=>{localStorage.getItem("credential")!==null?(d.value=!0,m.value=!0,c.value=!1):c.value=!0});async function I(){r.value=!0;try{const t=await(await fetch("https://webauth-firebase.onrender.com/registration-options",{mode:"cors",headers:{"Content-Type":"application/json"},credentials:"include"})).json();t.challenge=new Uint8Array(t.challenge.data),t.user.id=new Uint8Array(t.user.id.data),t.user.name="mypwa@example.com",t.user.displayName="my pwa auth test";const i=await navigator.credentials.create({publicKey:t}),a=n(i.rawId);localStorage.setItem("credential",JSON.stringify({credentialId:a}));const p={rawId:a,response:{attestationObject:n(i.response.attestationObject),clientDataJSON:n(i.response.clientDataJSON),id:i.id,type:i.type}};await(await fetch("https://webauth-firebase.onrender.com/register",{method:"POST",mode:"cors",headers:{"Content-Type":"application/json"},body:JSON.stringify({credential:p}),credentials:"include"})).json(),r.value=!1,c.value=!1,d.value=!0,m.value=!0,e.value="Registration successful!",o.value=!0}catch(t){console.error("registration failed",t),e.value="Registration failed",o.value=!0}finally{r.value=!1}}async function B(){r.value=!0;try{const t=await(await fetch("https://webauth-firebase.onrender.com/authentication-options",{mode:"cors",headers:{"Content-Type":"application/json"},credentials:"include"})).json(),{credentialId:i}=JSON.parse(localStorage.getItem("credential"));t.challenge=new Uint8Array(t.challenge.data),t.allowCredentials=[{id:w(i),type:"public-key",transports:["internal"]}];const a=await navigator.credentials.get({publicKey:t}),p={rawId:n(a.rawId),response:{authenticatorData:n(a.response.authenticatorData),signature:n(a.response.signature),userHandle:n(a.response.userHandle),clientDataJSON:n(a.response.clientDataJSON),id:a.id,type:a.type}},_=await fetch("https://webauth-firebase.onrender.com/authenticate",{method:"POST",mode:"cors",headers:{"Content-Type":"application/json"},body:JSON.stringify({credential:p}),credentials:"include"});if(_.status===404)e.value="Credential has expired, please register a new credential",o.value=!0,C();else{const M=await _.json();e.value="Authentication successful!",o.value=!0}}catch(t){console.error("authentication failed",t),e.value="Authentication failed",o.value=!0}finally{r.value=!1}}function C(){localStorage.removeItem("credential"),c.value=!0,d.value=!1,m.value=!1}const b={dialogInformation:o,dialogInformationMessage:e,loading:r,registerButton:c,authenticateButton:d,deleteButton:m,bufferToBase64:n,base64ToBuffer:w,handleRegisterCredential:I,handleAuthenticate:B,removeCredential:C,get mdiAccountPlus(){return Q},get mdiLogin(){return R},get mdiLogout(){return U},get mdiTrashCanOutline(){return L},onMounted:S,ref:l};return Object.defineProperty(b,"__isScriptSetup",{enumerable:!1,value:!0}),b}};function K(A,s,o,e,r,c){return g(),x("div",null,[e.registerButton?(g(),y(h,{key:0,size:"sm",round:"",loading:e.loading,icon:e.mdiAccountPlus,class:"q-ml-sm text-white",onClick:e.handleRegisterCredential},null,8,["loading","icon"])):v("",!0),e.authenticateButton?(g(),y(h,{key:1,size:"sm",round:"",loading:e.loading,icon:e.mdiLogin,class:"q-ml-sm text-white",onClick:e.handleAuthenticate},null,8,["loading","icon"])):v("",!0),e.deleteButton?(g(),y(h,{key:2,size:"sm",round:"",loading:e.loading,color:"red-5",icon:e.mdiTrashCanOutline,class:"q-ml-sm text-white",onClick:e.removeCredential},null,8,["loading","icon"])):v("",!0),u(P,{modelValue:e.dialogInformation,"onUpdate:modelValue":s[0]||(s[0]=d=>e.dialogInformation=d)},{default:f(()=>[u(T,null,{default:f(()=>[u(O,null,{default:f(()=>s[1]||(s[1]=[j("div",{class:"text-h6"},"Information Authentification",-1)])),_:1}),u(O,{class:"q-pt-none"},{default:f(()=>[k(D(e.dialogInformationMessage),1)]),_:1}),u(V,{align:"right"},{default:f(()=>[J(u(h,{flat:"",label:"OK",color:"primary"},null,512),[[q]])]),_:1})]),_:1})]),_:1},8,["modelValue"])])}const H=N(z,[["render",K],["__file","AuthentificationWidget.vue"]]);export{H as default};
